<div class="flex flex-col h-full w-full bg-gray-50">

  <!-- HEADER -->
  <div class="sticky top-0 z-10 bg-white border-b px-6 py-4 flex justify-between items-start shadow-sm">
    <div>
      <h2 class="text-xl font-bold text-gray-900">{{ ticket.titulo }}</h2>
      <p class="text-sm text-gray-500">
        {{ ticket.consorcioNombre }} Â· UF {{ ticket.unidadNombre }} â€¢ #{{ ticket.id }}
      </p>
    </div>
    <span class="px-3 py-1 text-xs rounded-full border font-medium"
          [ngClass]="{
            'bg-green-100 text-green-700 border-green-200': ticket.estado==='abierto',
            'bg-yellow-100 text-yellow-700 border-yellow-200': ticket.estado==='en_proceso',
            'bg-orange-100 text-orange-700 border-orange-200': ticket.estado==='pendiente',
            'bg-blue-100 text-blue-700 border-blue-200': ticket.estado==='resuelto',
            'bg-gray-100 text-gray-700 border-gray-200': ticket.estado==='cerrado'
          }">
      {{ ticket.estado | titlecase }}
    </span>
  </div>

  <!-- CONTENIDO -->
  <div class="flex-1 overflow-y-auto p-6">
    <form [formGroup]="ticketForm" (ngSubmit)="save()" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- COLUMNA IZQUIERDA -->
      <div class="lg:col-span-2 space-y-4">
        
        <!-- DescripciÃ³n original (solo lectura) -->
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <h3 class="font-semibold text-gray-800 mb-3">ğŸ“‹ DescripciÃ³n Original</h3>
          <p class="text-sm text-gray-700 whitespace-pre-line">{{ ticket.descripcion }}</p>
        </div>

        <!-- Historial de Comentarios (solo lectura) -->
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <h3 class="font-semibold text-gray-800 mb-3">ğŸ’¬ Historial</h3>
          <div class="space-y-3 max-h-96 overflow-y-auto">
            <div *ngFor="let h of historial" class="border-l-4 border-blue-300 pl-3 py-2 bg-gray-50 rounded">
              <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span class="font-medium">{{ h.autor || h.authorName }}</span>
                <span>{{ formatDate(h.fecha || h.createdAt) }}</span>
              </div>
              <p class="text-sm text-gray-700">{{ h.mensaje || h.message }}</p>
            </div>
          </div>
        </div>

      </div>

      <!-- COLUMNA DERECHA: FORMULARIO EDICIÃ“N -->
      <div class="space-y-4">
        
        <!-- Estado -->
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <label class="block font-semibold text-gray-800 mb-2">âš™ï¸ Estado</label>
          <select formControlName="estado" 
                  class="w-full border rounded-md px-3 py-2 text-sm">
            <option *ngFor="let e of estados" [ngValue]="e">{{ e | titlecase }}</option>
          </select>
        </div>

        <!-- AsignaciÃ³n -->
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <label class="block font-semibold text-gray-800 mb-2">ğŸ‘¤ AsignaciÃ³n</label>
          <input formControlName="asignadoANombre" 
                 placeholder="Nombre responsable" 
                 class="w-full border rounded-md px-3 py-2 text-sm mb-2" />
          <select formControlName="asignadoRol" 
                  class="w-full border rounded-md px-3 py-2 text-sm mb-2">
            <option [ngValue]="null">Seleccionar rol</option>
            <option value="proveedor">Proveedor</option>
            <option value="encargado">Encargado</option>
            <option value="admin_consorcio">Admin Consorcio</option>
            <option value="otro">Otro</option>
          </select>
          <input formControlName="proveedorId" 
                 type="number" 
                 placeholder="ID Proveedor (opcional)"
                 class="w-full border rounded-md px-3 py-2 text-sm" />
        </div>

        <!-- Costos -->
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <label class="block font-semibold text-gray-800 mb-2">ğŸ’° Costos</label>
          <input formControlName="estimacionCosto" 
                 type="number" 
                 placeholder="Costo estimado"
                 class="w-full border rounded-md px-3 py-2 text-sm mb-2" />
          <input formControlName="costoFinal" 
                 type="number" 
                 placeholder="Costo final"
                 class="w-full border rounded-md px-3 py-2 text-sm" />
        </div>

        <!-- Archivo -->
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <label class="block font-semibold text-gray-800 mb-2">ğŸ“ Adjuntar</label>
          <input type="file" 
                 (change)="onFileSelect($event)" 
                 class="w-full text-sm" />
          <p class="text-xs text-gray-400 mt-1">MÃ¡x 10MB</p>
        </div>

        <!-- Comentario OBLIGATORIO -->
        <div class="rounded-xl border bg-red-50 p-4 shadow-sm">
          <label class="block font-semibold text-gray-800 mb-2">
            ğŸ’¬ Comentario <span class="text-red-600">*</span>
          </label>
          <textarea formControlName="comentario" 
                    rows="4" 
                    placeholder="DescribÃ­ los cambios realizados..."
                    class="w-full border rounded-md px-3 py-2 text-sm resize-none"></textarea>
          <label class="flex items-center gap-2 mt-2 text-sm">
            <input type="checkbox" formControlName="comentarioInterno" />
            <span>Comentario interno (no visible para propietarios)</span>
          </label>
          <p *ngIf="ticketForm.get('comentario')?.invalid && ticketForm.get('comentario')?.touched" 
             class="text-xs text-red-600 mt-1">
            El comentario es obligatorio (mÃ­nimo 5 caracteres)
          </p>
        </div>

      </div>

    </form>
  </div>

  <!-- FOOTER -->
  <div class="sticky bottom-0 z-10 bg-white border-t px-6 py-3 flex justify-between shadow-lg">
    <button type="button"
            (click)="close()" 
            class="px-6 py-2 rounded-md border text-gray-700 hover:bg-gray-50">
      âœ–ï¸ Cancelar
    </button>
    <button type="button"
            (click)="save()"
            [disabled]="ticketForm.invalid || saving"
            class="px-6 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
      {{ saving ? 'â³ Guardando...' : 'ğŸ’¾ Guardar Cambios' }}
    </button>
  </div>

</div>