<div class="flex flex-col h-full w-full bg-gray-50">

  <!-- HEADER -->
  <div class="sticky top-0 z-10 bg-gradient-to-r from-blue-50 to-white border-b px-6 py-4 flex justify-between items-start shadow-sm">
    <div>
      <h2 class="text-xl font-bold text-gray-900">
        <span class="text-blue-600">#{{ ticket.id }}</span> - {{ ticket.titulo }}
      </h2>
      <p class="text-sm text-gray-600 mt-1">
        üè¢ {{ ticket.consorcioNombre }}
        <span *ngIf="ticket.unidadNombre" class="ml-2">¬∑ üè† UF {{ ticket.unidadNombre }}</span>
      </p>
    </div>
    <span class="px-4 py-1.5 text-xs rounded-full border font-semibold shadow-sm"
          [ngClass]="{
            'bg-green-100 text-green-700 border-green-300': ticket.estado==='abierto',
            'bg-yellow-100 text-yellow-700 border-yellow-300': ticket.estado==='en_proceso',
            'bg-orange-100 text-orange-700 border-orange-300': ticket.estado==='pendiente',
            'bg-blue-100 text-blue-700 border-blue-300': ticket.estado==='resuelto',
            'bg-gray-100 text-gray-700 border-gray-300': ticket.estado==='cerrado'
          }">
      {{ ticket.estado | titlecase }}
    </span>
  </div>

  <!-- CONTENIDO -->
  <div class="flex-1 overflow-y-auto p-6">
    <form [formGroup]="ticketForm" (ngSubmit)="save()" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- COLUMNA IZQUIERDA -->
      <div class="lg:col-span-2 space-y-4">
        
        <!-- Descripci√≥n original (solo lectura) -->
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <h3 class="font-semibold text-gray-800 mb-3">üìã Descripci√≥n Original</h3>
          <p class="text-sm text-gray-700 whitespace-pre-line">{{ ticket.descripcion }}</p>
        </div>

        <!-- NUEVO COMENTARIO (obligatorio) -->
        <div class="rounded-xl border-2 border-red-200 bg-gradient-to-br from-red-50 to-white p-4 shadow-md">
          <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
            <span class="text-lg">üí¨</span>
            <span>Agregar Comentario</span>
            <span class="text-red-600 font-bold">*</span>
            <span class="ml-auto text-xs font-normal text-red-600 bg-red-100 px-2 py-1 rounded-full">
              Obligatorio
            </span>
          </h3>
          <textarea formControlName="comentario"
                    rows="4"
                    placeholder="Describ√≠ los cambios realizados en este ticket..."
                    class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm resize-none mb-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                    [class.border-red-500]="ticketForm.get('comentario')?.invalid && ticketForm.get('comentario')?.touched"></textarea>
          <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer hover:text-gray-900">
            <input type="checkbox"
                   formControlName="comentarioInterno"
                   class="w-4 h-4 text-blue-600 rounded" />
            <span>üîí Comentario interno (no visible para propietarios)</span>
          </label>
          <p *ngIf="ticketForm.get('comentario')?.invalid && ticketForm.get('comentario')?.touched"
             class="text-xs text-red-600 mt-2 flex items-center gap-1">
            <span>‚ö†Ô∏è</span>
            <span>El comentario es obligatorio (m√≠nimo 5 caracteres)</span>
          </p>
        </div>

        <!-- Historial (solo lectura) -->
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <h3 class="font-semibold text-gray-800 mb-3">üìú Historial</h3>
          <div class="space-y-3 max-h-96 overflow-y-auto">
            <div *ngFor="let h of historial" class="border-l-4 border-blue-300 pl-3 py-2 bg-gray-50 rounded">
              <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span class="font-medium">{{ h.autor || h.authorName }}</span>
                <span>{{ formatDate(h.fecha || h.createdAt) }}</span>
              </div>
              <p class="text-sm text-gray-700">{{ h.mensaje || h.message }}</p>
            </div>
          </div>
        </div>

      </div>

      <!-- COLUMNA DERECHA: FORMULARIO EDICI√ìN -->
      <div class="space-y-4">
        
        <!-- Estado -->
        <div class="rounded-xl border bg-white p-4 shadow-sm hover:shadow-md transition-shadow">
          <label class="block font-semibold text-gray-800 mb-2 flex items-center gap-2">
            <span class="text-lg">‚öôÔ∏è</span>
            <span>Estado del Ticket</span>
          </label>
          <select formControlName="estado"
                  class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all cursor-pointer">
            <option *ngFor="let e of estados" [ngValue]="e">{{ e | titlecase }}</option>
          </select>
        </div>

        <!-- Asignaci√≥n Mejorada -->
        <div class="rounded-xl border bg-white p-4 shadow-sm hover:shadow-md transition-shadow">
          <label class="block font-semibold text-gray-800 mb-3 flex items-center gap-2">
            <span class="text-lg">üë§</span>
            <span>Asignaci√≥n</span>
          </label>

          <!-- Selector de tipo de asignaci√≥n -->
          <div class="mb-3">
            <label class="text-xs text-gray-600 mb-1 block font-medium">Tipo de asignaci√≥n</label>
            <select [value]="tipoAsignacion"
                    (change)="onTipoAsignacionChange($event)"
                    class="w-full border-2 border-gray-300 rounded-lg px-3 py-2.5 text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all cursor-pointer">
              <option *ngFor="let tipo of tiposAsignacion" [value]="tipo.value">
                {{ tipo.icon }} {{ tipo.label }}
              </option>
            </select>
          </div>

          <!-- B√∫squeda de Encargado -->
          <div *ngIf="tipoAsignacion === 'encargado'" class="space-y-2">
            <label class="text-xs text-gray-600 mb-1 block">Seleccionar encargado</label>
            <div class="relative">
              <input type="text"
                     [value]="encargadoSearchTerm"
                     (input)="onEncargadoSearchInput($any($event.target).value)"
                     (focus)="mostrarResultadosEncargados = encargadosEncontrados.length > 0"
                     placeholder="üîç Buscar o seleccionar encargado..."
                     class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                     autocomplete="off" />

              <!-- Resultados de b√∫squeda de encargados -->
              <div *ngIf="mostrarResultadosEncargados && encargadosEncontrados.length > 0"
                   class="absolute z-10 w-full mt-1 bg-white border-2 border-blue-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                <div class="sticky top-0 bg-blue-50 px-3 py-1.5 text-xs text-blue-700 font-medium border-b">
                  {{ encargadoSearchTerm.length >= 2 ? 'Resultados de b√∫squeda' : 'Encargados disponibles' }} ({{ encargadosEncontrados.length }})
                </div>
                <div *ngFor="let encargado of encargadosEncontrados"
                     (click)="seleccionarEncargado(encargado)"
                     class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 transition-colors">
                  <div class="font-medium text-sm text-gray-900">
                    {{ encargado.persona ? (encargado.persona.nombre + ' ' + encargado.persona.apellido) : encargado.username }}
                  </div>
                  <div class="text-xs text-gray-500">{{ encargado.email }}</div>
                </div>
              </div>

              <!-- Mensaje de ayuda -->
              <div *ngIf="encargadoSearchTerm.length > 0 && encargadoSearchTerm.length < 2"
                   class="text-xs text-blue-600 mt-1 flex items-center gap-1">
                <span>üí°</span>
                <span>Escrib√≠ al menos 2 caracteres para buscar</span>
              </div>
              <div *ngIf="encargadoSearchTerm.length === 0 && encargadosEncontrados.length === 0"
                   class="text-xs text-gray-400 mt-1">
                Cargando encargados...
              </div>
            </div>
          </div>

          <!-- B√∫squeda de Proveedor -->
          <div *ngIf="tipoAsignacion === 'proveedor'" class="space-y-2">
            <label class="text-xs text-gray-600 mb-1 block">Seleccionar proveedor</label>
            <div class="relative">
              <input type="text"
                     [value]="proveedorSearchTerm"
                     (input)="onProveedorSearchInput($any($event.target).value)"
                     (focus)="mostrarResultadosProveedores = proveedoresEncontrados.length > 0"
                     placeholder="üîç Buscar o seleccionar proveedor..."
                     class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                     autocomplete="off" />

              <!-- Resultados de b√∫squeda de proveedores -->
              <div *ngIf="mostrarResultadosProveedores && proveedoresEncontrados.length > 0"
                   class="absolute z-10 w-full mt-1 bg-white border-2 border-blue-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                <div class="sticky top-0 bg-blue-50 px-3 py-1.5 text-xs text-blue-700 font-medium border-b">
                  {{ proveedorSearchTerm.length >= 2 ? 'Resultados de b√∫squeda' : 'Proveedores activos' }} ({{ proveedoresEncontrados.length }})
                </div>
                <div *ngFor="let proveedor of proveedoresEncontrados"
                     (click)="seleccionarProveedor(proveedor)"
                     class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 transition-colors">
                  <div class="font-medium text-sm text-gray-900">{{ proveedor.razon_social }}</div>
                  <div class="text-xs text-gray-500">{{ proveedor.rubro }}</div>
                </div>
              </div>

              <!-- Mensaje de ayuda -->
              <div *ngIf="proveedorSearchTerm.length > 0 && proveedorSearchTerm.length < 2"
                   class="text-xs text-blue-600 mt-1 flex items-center gap-1">
                <span>üí°</span>
                <span>Escrib√≠ al menos 2 caracteres para buscar</span>
              </div>
              <div *ngIf="proveedorSearchTerm.length === 0 && proveedoresEncontrados.length === 0"
                   class="text-xs text-gray-400 mt-1">
                Cargando proveedores...
              </div>
            </div>
          </div>

          <!-- B√∫squeda de Persona -->
          <div *ngIf="tipoAsignacion === 'persona'" class="space-y-2">
            <label class="text-xs text-gray-600 mb-1 block">Seleccionar persona o usuario</label>
            <div class="relative">
              <input type="text"
                     [value]="personaSearchTerm"
                     (input)="onPersonaSearchInput($any($event.target).value)"
                     (focus)="mostrarResultadosPersonas = personasEncontradas.length > 0"
                     placeholder="üîç Buscar o seleccionar persona..."
                     class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                     autocomplete="off" />

              <!-- Resultados de b√∫squeda de personas -->
              <div *ngIf="mostrarResultadosPersonas && personasEncontradas.length > 0"
                   class="absolute z-10 w-full mt-1 bg-white border-2 border-blue-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                <div class="sticky top-0 bg-blue-50 px-3 py-1.5 text-xs text-blue-700 font-medium border-b">
                  {{ personaSearchTerm.length >= 2 ? 'Resultados de b√∫squeda' : 'Usuarios disponibles' }} ({{ personasEncontradas.length }})
                </div>
                <div *ngFor="let persona of personasEncontradas"
                     (click)="seleccionarPersona(persona)"
                     class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 transition-colors">
                  <div class="font-medium text-sm text-gray-900">{{ getPersonaNombre(persona) }}</div>
                  <div class="text-xs text-gray-500">{{ getPersonaEmail(persona) }}</div>
                </div>
              </div>

              <!-- Mensaje de ayuda -->
              <div *ngIf="personaSearchTerm.length > 0 && personaSearchTerm.length < 2"
                   class="text-xs text-blue-600 mt-1 flex items-center gap-1">
                <span>üí°</span>
                <span>Escrib√≠ al menos 2 caracteres para buscar</span>
              </div>
              <div *ngIf="personaSearchTerm.length === 0 && personasEncontradas.length === 0"
                   class="text-xs text-gray-400 mt-1">
                Cargando usuarios...
              </div>
            </div>
          </div>

        </div>

        <!-- Costos -->
        <div class="rounded-xl border bg-white p-4 shadow-sm hover:shadow-md transition-shadow">
          <label class="block font-semibold text-gray-800 mb-3 flex items-center gap-2">
            <span class="text-lg">üí∞</span>
            <span>Costos</span>
          </label>
          <div class="space-y-2">
            <div>
              <label class="text-xs text-gray-600 mb-1 block">Estimaci√≥n</label>
              <input formControlName="estimacionCosto"
                     type="number"
                     placeholder="$ Costo estimado"
                     class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" />
            </div>
            <div>
              <label class="text-xs text-gray-600 mb-1 block">Costo Final</label>
              <input formControlName="costoFinal"
                     type="number"
                     placeholder="$ Costo final"
                     class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" />
            </div>
          </div>
        </div>

        <!-- Archivo -->
        <div class="rounded-xl border bg-white p-4 shadow-sm hover:shadow-md transition-shadow">
          <label class="block font-semibold text-gray-800 mb-3 flex items-center gap-2">
            <span class="text-lg">üìé</span>
            <span>Adjuntar Archivo</span>
          </label>
          <input type="file"
                 (change)="onFileSelect($event)"
                 class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
          <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
            <span>‚ÑπÔ∏è</span>
            <span>M√°ximo 10MB</span>
          </p>
        </div>

      </div>

    </form>
  </div>

  <!-- FOOTER -->
  <div class="sticky bottom-0 z-10 bg-gradient-to-r from-gray-50 to-white border-t px-6 py-4 flex justify-between items-center shadow-lg">
    <button type="button"
            (click)="close()"
            class="px-6 py-2.5 rounded-lg border-2 border-gray-300 text-gray-700 font-medium hover:bg-gray-50 hover:border-gray-400 transition-all flex items-center gap-2">
      <span>‚úñÔ∏è</span>
      <span>Cancelar</span>
    </button>
    <button type="button"
            (click)="save()"
            [disabled]="ticketForm.invalid || saving"
            class="px-6 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg transition-all flex items-center gap-2">
      <span *ngIf="!saving">üíæ</span>
      <span *ngIf="saving" class="animate-spin">‚è≥</span>
      <span>{{ saving ? 'Guardando...' : 'Guardar Cambios' }}</span>
    </button>
  </div>

</div>